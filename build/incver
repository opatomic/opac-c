#!/bin/bash

function handleErr {
	SNAME=$(basename $BASH_SOURCE)
	echo "$SNAME: Error on line $1"
	exit 1
}

trap 'handleErr $LINENO' ERR

MODCNT=`git status --porcelain | wc -l`
if [ $MODCNT -ne 0 ]; then
	echo "There are $MODCNT changes. Must revert or check in changes."
	exit 1
fi

if [ "$(git log --oneline $(git describe --tags --abbrev=0)..HEAD | wc -l)" = "0" ]; then
	echo "No changes since last tag"
	exit 1
fi

HVERPATH="../src/opacversion.h"

if [[ ! `cut -b 1-22 $HVERPATH` == "#define OPAC_VERSION \"" ]]; then
	echo "$HVERPATH has been modified?"
	exit 1
fi
VERSION=`cut -d '"' -f2 < $HVERPATH | awk -F '.' '{printf("%d.%d.%d",$1,$2,$3+1)}'`

printf "#define OPAC_VERSION \"$VERSION\"\n" > "$HVERPATH"

# run a build to make sure there's no problems building
./build

# TODO: run tests here; do not proceed if they fail

rm -r out

git add $HVERPATH

git commit -m "increment version to v$VERSION"
git tag -a "v$VERSION" -m "v$VERSION"

echo "committed and tagged v$VERSION"

git push --follow-tags


